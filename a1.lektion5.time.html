<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…ì¼ì–´ ì‹œê°„ ì½ê¸° í€´ì¦ˆ</title>
    <!-- Inter í°íŠ¸ì™€ Tailwind CSSë¥¼ ë¡œë“œí•©ë‹ˆë‹¤ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #voice-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
        .animate-pulse {
          animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* ì‹œê³„ ë°°ê²½ ë° í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ */
        #clock-display-container {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #f7fafc; /* light gray background */
        }
    </style>
    <!-- Font Awesome ì•„ì´ì½˜ì„ ë¡œë“œí•©ë‹ˆë‹¤ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="quiz-container" class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl max-w-lg w-full flex flex-col items-center text-center space-y-8 border border-gray-200">
        <!-- í€´ì¦ˆ ì œëª© -->
        <div class="w-full">
            <h1 class="text-4xl font-extrabold text-violet-700">ë…ì¼ì–´ ì‹œê°„ ì½ê¸° í€´ì¦ˆ â°</h1>
            <!-- ì´ ë¬¸êµ¬ì˜ IDë¥¼ ì¶”ê°€í•˜ì—¬ JSì—ì„œ ì œì–´í•©ë‹ˆë‹¤. -->
            <p id="selection-prompt" class="text-sm text-gray-500 mt-1">í•™ìŠµí•  ëª¨ë“œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
        </div>

        <!-- 1. ë²„ì „ ì„ íƒ ì˜ì—­ -->
        <div id="version-selection-area" class="w-full space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700">ë²„ì „ ì„ íƒ</h2>
            
            <!-- ì‹œê°„ ë§í•˜ê¸° 1 (í˜•ì‹ë§Œ) - ì„¤ëª… ìˆ˜ì •ë¨ -->
            <button id="mode-formal-only" class="w-full p-6 bg-blue-500 hover:bg-blue-600 text-white font-extrabold rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-[1.02]">
                <div class="text-3xl">ì‹œê°„ ë§í•˜ê¸° 1</div>
                <div class="text-sm mt-1">ì˜ˆì‹œ: neun Uhr fÃ¼nfzehn (9:15)</div>
            </button>
            
            <!-- ì‹œê°„ ë§í•˜ê¸° 2 (ë¹„í˜•ì‹ë§Œ) - ì„¤ëª… ìˆ˜ì •ë¨ -->
            <button id="mode-mixed" class="w-full p-6 bg-lime-500 hover:bg-lime-600 text-white font-extrabold rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-[1.02]">
                <div class="text-3xl">ì‹œê°„ ë§í•˜ê¸° 2</div>
                <div class="text-sm mt-1">ì˜ˆì‹œ: Viertel nach neun (9:15)</div>
            </button>
        </div>

        <!-- 2. í€´ì¦ˆ ì§„í–‰ ì˜ì—­ -->
        <div id="quiz-area" class="hidden w-full space-y-6">
            <p id="progress-text" class="text-sm text-gray-500 mt-2">ë¬¸ì œ 0 / 0</p>
            <!-- ëª¨ë“œ ì •ë³´ê°€ ê°„ê²°í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤. -->
            <p id="mode-info" class="text-xs font-medium text-blue-700 h-4"></p>
            
            <!-- ì‹œê³„ ë° ì§ˆë¬¸ í‘œì‹œ ì˜ì—­: ì‹œê³„ ì¶”ê°€ -->
            <div class="flex flex-col items-center justify-center w-full space-y-4">
                <!-- ì•„ë‚ ë¡œê·¸ ì‹œê³„ SVG ì»¨í…Œì´ë„ˆ -->
                <div id="clock-display-container" class="w-48 h-48 sm:w-60 sm:h-60 rounded-full bg-white shadow-xl border-4 border-gray-300 relative p-2">
                    <svg id="analog-clock" viewBox="0 0 100 100" class="w-full h-full">
                        <!-- Clock Face Marks (Longer lines for 12, 3, 6, 9) -->
                        <g stroke="#333" stroke-width="1.2">
                            <line x1="50" y1="3" x2="50" y2="7" transform="rotate(0, 50, 50)" />
                            <line x1="50" y1="3" x2="50" y2="7" transform="rotate(90, 50, 50)" />
                            <line x1="50" y1="3" x2="50" y2="7" transform="rotate(180, 50, 50)" />
                            <line x1="50" y1="3" x2="50" y2="7" transform="rotate(270, 50, 50)" />
                        </g>
                        <!-- Smaller marks -->
                        <g stroke="#777" stroke-width="0.5">
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(30, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(60, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(120, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(150, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(210, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(240, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(300, 50, 50)" />
                            <line x1="50" y1="4" x2="50" y2="6" transform="rotate(330, 50, 50)" />
                        </g>
                        
                        <!-- Clock Numbers (1-12) -->
                        <g id="clock-numbers" fill="#333" font-size="8" text-anchor="middle" dominant-baseline="central" font-weight="600">
                            <text x="50" y="10">12</text>
                            <text x="70" y="15">1</text>
                            <text x="85" y="30">2</text>
                            <text x="90" y="50">3</text>
                            <text x="85" y="70">4</text>
                            <text x="70" y="85">5</text>
                            <text x="50" y="90">6</text>
                            <text x="30" y="85">7</text>
                            <text x="15" y="70">8</text>
                            <text x="10" y="50">9</text>
                            <text x="15" y="30">10</text>
                            <text x="30" y="15">11</text>
                        </g>

                        <!-- Clock Hands -->
                        <line id="hour-hand" x1="50" y1="50" x2="50" y2="25" stroke="#222" stroke-width="3.5" stroke-linecap="round" />
                        <line id="minute-hand" x1="50" y1="50" x2="50" y2="15" stroke="#222" stroke-width="2.5" stroke-linecap="round" />
                        
                        <!-- Center dot -->
                        <circle cx="50" cy="50" r="3" fill="#A855F7" stroke="#222" stroke-width="1.5" />
                    </svg>
                </div>
                
                <!-- ë””ì§€í„¸ ì‹œê°„ í‘œì‹œ (ë¬¸ì œ) -->
                <div class="h-10 flex flex-col items-center justify-center bg-violet-50 rounded-xl p-2 w-full transition-colors duration-300 shadow-inner">
                    <p id="question" class="text-2xl font-bold text-gray-800">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                <!-- word-infoëŠ” ì´ì œ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ h-4ë¡œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤. -->
                <p id="word-info" class="text-xs text-gray-500 h-4"></p>
            </div>
            
            <!-- ì‚¬ìš©ì ì…ë ¥ í•„ë“œ ë° ìŒì„± ì…ë ¥ ë²„íŠ¼ í†µí•© -->
            <div class="relative w-full mt-4">
                <!-- Placeholder: "ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”" -->
                <input type="text" id="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”" class="w-full p-4 pr-14 text-xl rounded-2xl border-2 border-violet-300 focus:border-violet-600 focus:outline-none transition-all duration-200 shadow-md">
                
                <button id="voice-input-button" class="absolute right-0 top-0 h-full w-14 bg-transparent text-zinc-500 hover:text-red-600 rounded-r-2xl transition-all duration-200 focus:outline-none" title="ìŒì„±ìœ¼ë¡œ ì •ë‹µ ì…ë ¥">
                    <!-- ë§ˆì´í¬ ì•„ì´ì½˜ í´ë˜ìŠ¤ ìˆ˜ì • ì™„ë£Œ -->
                    <i class="fas fa-microphone text-xl"></i> 
                </button>
            </div>
            
            <!-- STT ì¸ì‹ ê²°ê³¼ í‘œì‹œ (ì œê±°ë˜ì—ˆìœ¼ë‚˜ êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ ë¹ˆ ê³µê°„ìœ¼ë¡œ ë‚¨ê²¨ë‘ ) -->
            <p id="stt-result-display" class="text-sm text-gray-700 font-medium h-4 mt-2 invisible"></p>
            
            <!-- í”¼ë“œë°± ë©”ì‹œì§€ ì˜ì—­ -->
            <p id="feedback" class="text-lg min-h-[2rem] font-extrabold mb-2"></p>
            
            <!-- ë°œìŒ ì—°ìŠµ ì•ˆë‚´ ë¬¸êµ¬ (ìš”ì²­ ìœ„ì¹˜ë¡œ ì´ë™) -->
            <p id="pronunciation-guide" class="text-sm text-gray-600 mb-3 text-center h-5 font-medium"></p>

            <!-- 1. ë°œìŒ ì¬ìƒ ë° ë…¹ìŒ ë²„íŠ¼ -->
            <div id="playback-buttons" class="flex gap-3 justify-center flex-wrap pt-2 hidden">
                <button id="native-listen-button" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105 text-sm md:text-base">
                    <i class="fas fa-volume-up mr-1"></i> ë“£ê¸°
                </button>
                <button id="record-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105 text-sm md:text-base">
                    <i class="fas fa-microphone mr-1"></i> ë…¹ìŒ
                </button>
                <button id="my-pronunciation-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105 text-sm md:text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-headphones mr-1"></i> ì¬ìƒ
                </button>
            </div>
            
            <!-- 2. ë²„íŠ¼ ê·¸ë£¹ (í™•ì¸/ë‹¤ìŒ) -->
            <div class="flex space-x-4 justify-center pt-2">
                <button id="check-button" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-105">
                    <i class="fas fa-check mr-2"></i> í™•ì¸
                </button>
                <button id="next-button" class="bg-gray-400 text-white font-bold py-4 px-6 rounded-2xl shadow-lg cursor-not-allowed transition-all duration-200" disabled>
                    <i class="fas fa-arrow-right mr-2"></i> ë‹¤ìŒ ë¬¸ì œ
                </button>
            </div>
        </div>

        <!-- 3. ìµœì¢… ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
        <div id="result-area" class="hidden w-full space-y-6">
            <h2 class="text-3xl font-bold text-violet-700">í€´ì¦ˆ ì™„ë£Œ! ğŸ‰</h2>
            <!-- scoreTextëŠ” JSì—ì„œ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ -->
            <p id="score-text" class="text-2xl text-gray-700">ì ìˆ˜: 0 / 0</p>
            <button id="restart-button" class="bg-lime-600 hover:bg-lime-700 text-white font-bold py-4 px-8 rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-redo-alt mr-2"></i> ë‹¤ì‹œ ì‹œì‘
            </button>
            <button id="go-to-selection" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-8 rounded-2xl shadow-lg transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-list mr-2"></i> ëª¨ë“œ ì„ íƒìœ¼ë¡œ
            </button>
        </div>
    </div>

    <script>
        // --- í€´ì¦ˆ ë°ì´í„° ì •ì˜ ---
        
        // 1. í˜•ì‹ í‘œí˜„ë§Œ ìˆëŠ” ë¬¸ì œ (ì‹œê°„ ë§í•˜ê¸° 1ì— í¬í•¨)
        const formalOnlyQuestions = [
            { korean: "18:08 Uhr", german: ["achtzehn Uhr acht"] },
            { korean: "02:59 Uhr", german: ["zwei Uhr neunundfÃ¼nfzig"] },
            { korean: "13:03 Uhr", german: ["dreizehn Uhr drei"] },
            { korean: "00:49 Uhr", german: ["null Uhr neunundvierzig"] },
            { korean: "08:00 Uhr", german: ["acht Uhr"] },
            { korean: "14:35 Uhr", german: ["vierzehn Uhr fÃ¼nfunddreiÃŸig"] },
            { korean: "23:07 Uhr", german: ["dreiundzwanzig Uhr sieben"] },
            { korean: "17:01 Uhr", german: ["siebzehn Uhr eins"] },
            { korean: "16:28 Uhr", german: ["sechzehn Uhr achtundzwanzig"] },
            { korean: "09:10 Uhr", german: ["neun Uhr zehn"] },
            { korean: "20:25 Uhr", german: ["zwanzig Uhr fÃ¼nfundzwanzig"] },
            { korean: "12:34 Uhr", german: ["zwÃ¶lf Uhr vierunddreiÃŸig"] }, 
            { korean: "05:06 Uhr", german: ["fÃ¼nf Uhr sechs"] },
            { korean: "17:38 Uhr", german: ["siebzehn Uhr achtunddreiÃŸig"] },
        ];

        // 2. ë¹„í˜•ì‹ í‘œí˜„ì´ ìˆëŠ” ë¬¸ì œ (ì‹œê°„ ë§í•˜ê¸° 2ì˜ ìœ ì¼í•œ ë¬¸ì œ ëª©ë¡)
        // [Formal, Informal] ìˆœì„œ
        const informalTargetQuestions = [
            { korean: "07:30 Uhr", german: ["sieben Uhr dreiÃŸig", "halb acht"] },
            { korean: "08:05 Uhr", german: ["acht Uhr fÃ¼nf", "fÃ¼nf nach acht"] },
            { korean: "09:15 Uhr", german: ["neun Uhr fÃ¼nfzehn", "Viertel nach neun"] },
            { korean: "10:20 Uhr", german: ["zehn Uhr zwanzig", "zwanzig nach zehn"] },
            { korean: "11:40 Uhr", german: ["elf Uhr vierzig", "zwanzig vor zwÃ¶lf"] },
            { korean: "12:45 Uhr", german: ["zwÃ¶lf Uhr fÃ¼nfundvierzig", "Viertel vor eins"] },
            { korean: "13:55 Uhr", german: ["dreizehn Uhr fÃ¼nfundfÃ¼nfzig", "fÃ¼nf vor zwei"] },
            { korean: "14:30 Uhr", german: ["vierzehn Uhr dreiÃŸig", "halb drei"] }, 
            { korean: "15:05 Uhr", "german": ["fÃ¼nfzehn Uhr fÃ¼nf", "fÃ¼nf nach drei"] },
            { korean: "16:15 Uhr", german: ["sechzehn Uhr fÃ¼nfzehn", "Viertel nach vier"] },
            { korean: "17:20 Uhr", german: ["siebzehn Uhr zwanzig", "zwanzig nach fÃ¼nf"] }, 
            { korean: "18:40 Uhr", german: ["achtzehn Uhr vierzig", "zwanzig vor sieben"] },
            { korean: "19:45 Uhr", german: ["neunzehn Uhr fÃ¼nfundvierzig", "Viertel vor acht"] },
            { korean: "20:55 Uhr", german: ["zwanzig Uhr fÃ¼nfundfÃ¼nfzig", "fÃ¼nf vor neun"] },
        ]; 
        
        // ì „ì²´ í€´ì¦ˆ ë°ì´í„° (ì‹œê°„ ë§í•˜ê¸° 1ì—ì„œ ì‚¬ìš©)
        const quizData = formalOnlyQuestions.concat(informalTargetQuestions);

        // --- ì „ì—­ ìƒíƒœ ë³€ìˆ˜ ---
        const selectionArea = document.getElementById('version-selection-area');
        const quizArea = document.getElementById('quiz-area');
        const resultArea = document.getElementById('result-area');
        const questionElement = document.getElementById('question');
        // wordInfoElementëŠ” ì´ì œ ë°œìŒ ì•ˆë‚´ ë¬¸êµ¬ ì €ì¥ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const wordInfoElement = document.getElementById('word-info'); 
        const answerInput = document.getElementById('answer-input');
        const feedbackElement = document.getElementById('feedback');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');
        const restartButton = document.getElementById('restart-button');
        const goToSelectionButton = document.getElementById('go-to-selection');
        const scoreText = document.getElementById('score-text');
        const progressText = document.getElementById('progress-text');
        const modeInfoElement = document.getElementById('mode-info');
        const sttResultDisplay = document.getElementById('stt-result-display');
        
        const modeFormalButton = document.getElementById('mode-formal-only');
        const modeMixedButton = document.getElementById('mode-mixed');
        
        const playbackButtons = document.getElementById('playback-buttons');
        const nativeListenButton = document.getElementById('native-listen-button');
        const recordButton = document.getElementById('record-button'); 
        const myPronunciationButton = document.getElementById('my-pronunciation-button'); 
        const voiceInputButton = document.getElementById('voice-input-button'); 
        
        const clockDisplayContainer = document.getElementById('clock-display-container'); // ì‹œê³„ ì»¨í…Œì´ë„ˆ
        const hourHand = document.getElementById('hour-hand');
        const minuteHand = document.getElementById('minute-hand');
        
        const selectionPrompt = document.getElementById('selection-prompt');
        // ìƒˆë¡œìš´ ë°œìŒ ì—°ìŠµ ì•ˆë‚´ ë¬¸êµ¬ ìš”ì†Œ
        const pronunciationGuide = document.getElementById('pronunciation-guide');


        let currentQuestionIndex = 0;
        let score = 0;
        let currentMode = 'formal'; // ê¸°ë³¸ ëª¨ë“œ ì„¤ì •
        let currentQuizSet = []; // í˜„ì¬ í€´ì¦ˆì— ì‚¬ìš©ë˜ëŠ” ë¬¸ì œ ëª©ë¡
        let rawSttResult = ''; // STTì˜ ì›ë³¸ ì¸ì‹ ê²°ê³¼ ì €ì¥

        // ë…¹ìŒ/ìŒì„± ì¸ì‹ ê´€ë ¨ ìƒíƒœ ë³€ìˆ˜
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        const isSttSupported = !!SpeechRecognition; 
        
        if (isSttSupported) {
            recognition = new SpeechRecognition();
            recognition.lang = 'de-DE'; // ë…ì¼ì–´ ì„¤ì • ìœ ì§€
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                
                rawSttResult = result.trim();
                
                // STT ì¸ì‹ ê²°ê³¼ë¥¼ í™”ë©´ì— ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œí•˜ëŠ” ë¬¸êµ¬ ì œê±°ë¨
                answerInput.value = rawSttResult; // ì…ë ¥ì°½ì— STT ê²°ê³¼ë¥¼ ë°˜ì˜
                stopListening();
                
                if (!checkButton.disabled) {
                    // ìŒì„± ì…ë ¥ í›„ ìë™ í™•ì¸ (trueë¥¼ ì „ë‹¬í•˜ì—¬ ìŒì„± ì…ë ¥ì„ì„ ì•Œë¦¼)
                    checkAnswer(true); 
                } else {
                    showMessage('âœ… ìŒì„± ì…ë ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', false);
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'aborted') {
                    console.warn('Speech recognition status:', event.error);
                } else {
                    console.error('Speech recognition error:', event.error);
                }
                
                stopListening();
                if (event.error === 'not-allowed') {
                    showMessage('âš ï¸ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.', true);
                } else if (event.error === 'no-speech') {
                    showMessage('âš ï¸ ìŒì„± ì¸ì‹ì´ ì•ˆ ëìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', true); 
                } else if (event.error !== 'aborted') { 
                    showMessage(`âš ï¸ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`, true);
                }
            };

            recognition.onend = () => {
                isListening = false;
            };
        }
        
        function toggleVoiceInput() {
            if (!isSttSupported) {
                showMessage('âš ï¸ ìŒì„± ì¸ì‹(STT)ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', true);
                return;
            }
            if (currentQuestionIndex >= currentQuizSet.length) {
                showMessage('âš ï¸ í€´ì¦ˆê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.', true);
                return;
            }

            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (!recognition) return;
            try {
                if (isListening) { 
                     recognition.abort(); 
                }
                
                rawSttResult = '';
                
                recognition.start();
                isListening = true;
                voiceInputButton.classList.remove('text-zinc-500', 'hover:text-red-600');
                voiceInputButton.classList.add('text-red-600', 'animate-pulse');
                showMessage('ğŸ¤ ë…ì¼ì–´ë¡œ ì •ë‹µì„ ë§ì”€í•˜ì„¸ìš”.', false);
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    showMessage('âš ï¸ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.', true);
                } else {
                    console.error('STT Start Error:', error);
                    showMessage('âš ï¸ ìŒì„± ì¸ì‹ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
                }
            }
        }

        function stopListening() {
             if (!recognition) return;
             if (isListening) {
                 recognition.abort(); 
             }
             voiceInputButton.classList.remove('text-red-600', 'animate-pulse');
             voiceInputButton.classList.add('text-zinc-500', 'hover:text-red-600');
             isListening = false;
        }


        // --- í—¬í¼ í•¨ìˆ˜ ---

        function showMessage(message, isError = false) {
            feedbackElement.textContent = message;
            feedbackElement.classList.remove('text-green-600', 'text-red-600', 'text-gray-800');
            feedbackElement.classList.add(isError ? 'text-red-600' : 'text-gray-800');
        }
        
        /**
         * ì‚¬ìš©ì ì…ë ¥ì„ ì†Œë¬¸ìí™”, ê³µë°± ì •ë¦¬, êµ¬ë‘ì  ì œê±° ë“± ì¼ë°˜ì ì¸ ì •ê·œí™” ì²˜ë¦¬
         */
        function normalizeVoiceInput(text) {
            let normalized = text.toLowerCase().trim();
            normalized = normalized.replace(/[.,!?:;]$/, '');
            normalized = normalized.replace(/\s+/g, ' ').trim(); 
            return normalized;
        }
        
        // ë…ì¼ì–´ ìˆ«ì ë‹¨ì–´ì™€ ë””ì§€í„¸ ê°’ ë§¤í•‘ (ì‹œê°„ ê´€ë ¨ ìˆ«ìë§Œ í¬í•¨)
        const numberWordMap = {
            'eins': '1', 'zwei': '2', 'drei': '3', 'vier': '4', 'fÃ¼nf': '5', 'sechs': '6', 
            'sieben': '7', 'acht': '8', 'neun': '9', 'zehn': '10', 'elf': '11', 'zwÃ¶lf': '12',
            'dreizehn': '13', 'vierzehn': '14', 'fÃ¼nfzehn': '15', 'sechzehn': '16', 'siebzehn': '17',
            'achtzehn': '18', 'neunzehn': '19', 'zwanzig': '20',
            'viertel': '15', // 'Viertel nach' for 15
            'fÃ¼nfundzwanzig': '25',
            'dreiÃŸig': '30',
            'vierzig': '40', 'fÃ¼nfzig': '50',
            'ein': '1', // special case for 'ein Uhr' 
            'null': '0' // 'null Uhr'
        };

        /**
         * ë…ì¼ì–´ ë‹¨ì–´ ì •ë‹µì„ STTê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” ìˆ«ì+ë…ì¼ì–´ í˜¼í•© í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * (ì˜ˆ: "zwanzig nach fÃ¼nf" -> "20 nach 5")
         */
        function normalizeToMixedDigit(phrase) {
            let mixedPhrase = normalizeVoiceInput(phrase);
            
            // Replace known number words with digits
            for (const [word, digit] of Object.entries(numberWordMap)) {
                // Use regex to replace the whole word only (using \b word boundaries)
                const regex = new RegExp(`\\b${word}\\b`, 'g');
                mixedPhrase = mixedPhrase.replace(regex, digit);
            }
            
            // Clean up spaces and return
            return mixedPhrase.replace(/\s+/g, ' ').trim();
        }

        /**
         * SVG ì‹œê³„ ë°”ëŠ˜ì„ ê·¸ë¦½ë‹ˆë‹¤.
         * @param {string} timeString "HH:MM Uhr" í˜•ì‹ì˜ ì‹œê°„ ë¬¸ìì—´
         */
        function renderClock(timeString) {
            const time = timeString.replace(' Uhr', '');
            const [hour24, minute] = time.split(':').map(Number);
            
            // 12ì‹œ ê¸°ì¤€ìœ¼ë¡œ ì‹œì¹¨ ê°ë„ ê³„ì‚°
            const hour = hour24 % 12; // 0-11
            
            // ì‹œì¹¨ ê°ë„: (ì‹œ/12 * 360) + (ë¶„/60 * 30) (ë¶„ë‹¹ 0.5ë„)
            const hourAngle = (hour / 12) * 360 + (minute / 60) * 30;
            
            // ë¶„ì¹¨ ê°ë„: (ë¶„/60 * 360) (ë¶„ë‹¹ 6ë„)
            const minuteAngle = (minute / 60) * 360; 
            
            if (hourHand && minuteHand) {
                // SVG transform ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ë°”ëŠ˜ íšŒì „ (50, 50ì„ ì¤‘ì‹¬ìœ¼ë¡œ)
                hourHand.setAttribute('transform', `rotate(${hourAngle}, 50, 50)`);
                minuteHand.setAttribute('transform', `rotate(${minuteAngle}, 50, 50)`);
            }
        }

        // --- í€´ì¦ˆ ë¡œì§ í•¨ìˆ˜ ---
        
        function showSelectionScreen() {
            selectionArea.classList.remove('hidden');
            quizArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            
            // ëª¨ë“œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë‹¤ì‹œ í‘œì‹œí•©ë‹ˆë‹¤. (ì´ì „ ìš”ì²­ ë°˜ì˜)
            if (selectionPrompt) {
                selectionPrompt.classList.remove('hidden');
            }
        }

        function startQuiz(mode) {
            currentMode = mode;
            currentQuestionIndex = 0;
            score = 0;
            
            // ëª¨ë“œ ì„ íƒ í›„ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤. (ì´ì „ ìš”ì²­ ë°˜ì˜)
            if (selectionPrompt) {
                selectionPrompt.classList.add('hidden');
            }
            
            // ëª¨ë“œì— ë”°ë¼ ë¬¸ì œ ì„¸íŠ¸ ì„¤ì • ë° ëª¨ë“œ ì •ë³´ í…ìŠ¤íŠ¸ ìˆ˜ì •
            if (currentMode === 'formal') {
                // ì‹œê°„ ë§í•˜ê¸° 1: ëª¨ë“  ë¬¸ì œ ì‚¬ìš© (í˜•ì‹ê³¼ ë¹„í˜•ì‹ í˜¼í•©)
                currentQuizSet = [...quizData]; 
                
                // ëª¨ë“œ ì´ë¦„ë§Œ í‘œì‹œ
                modeInfoElement.textContent = `í˜„ì¬ ëª¨ë“œ: ì‹œê°„ ë§í•˜ê¸° 1 (í˜•ì‹ í‘œí˜„ ìœ„ì£¼)`;
                
                modeInfoElement.classList.remove('text-lime-700');
                modeInfoElement.classList.add('text-blue-700');
                
                // ì‹œê³„ ê·¸ë¦¼ ìˆ¨ê¸°ê¸° (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
                clockDisplayContainer.classList.add('hidden'); 

            } else {
                // ì‹œê°„ ë§í•˜ê¸° 2: ë¹„í˜•ì‹ í‘œí˜„ì´ ìˆëŠ” ë¬¸ì œë§Œ ì‚¬ìš© (ì‚¬ìš©ì ìš”ì²­)
                currentQuizSet = [...informalTargetQuestions]; 
                
                // ëª¨ë“œ ì´ë¦„ë§Œ í‘œì‹œ
                modeInfoElement.textContent = `í˜„ì¬ ëª¨ë“œ: ì‹œê°„ ë§í•˜ê¸° 2 (ë¹„í˜•ì‹ í‘œí˜„ ìœ„ì£¼)`;
                
                modeInfoElement.classList.remove('text-blue-700');
                modeInfoElement.classList.add('text-lime-700');
                
                // ì‹œê³„ ê·¸ë¦¼ í‘œì‹œ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
                clockDisplayContainer.classList.remove('hidden'); 
            }
            
            // ë¬¸ì œ ì…”í”Œ
            currentQuizSet.sort(() => Math.random() - 0.5);
            
            selectionArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            quizArea.classList.remove('hidden');

            loadQuestion();
            updateProgress();
        }

        function loadQuestion() {
            stopListening();
            
            if (currentQuestionIndex < currentQuizSet.length) {
                const currentQuestion = currentQuizSet[currentQuestionIndex];
                
                // ì‹œê³„ ë Œë”ë§ (ì‹œê³„ê°€ ìˆ¨ê²¨ì ¸ ìˆì–´ë„ ë°ì´í„°ëŠ” ì—…ë°ì´íŠ¸)
                renderClock(currentQuestion.korean); 

                questionElement.textContent = currentQuestion.korean; 
                wordInfoElement.textContent = ''; 
                wordInfoElement.classList.remove('text-green-600', 'text-red-600');
                wordInfoElement.classList.add('text-gray-500');

                answerInput.value = '';
                feedbackElement.textContent = '';
                pronunciationGuide.textContent = ''; // ë¬¸êµ¬ ìœ„ì¹˜ ë³€ê²½ì— ë”°ë¼ ì´ˆê¸°í™”
                
                // STT ê²°ê³¼ ê´€ë ¨ ë¦¬ì…‹ (í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ)
                rawSttResult = '';
                
                isRecording = false;
                recordedChunks = [];
                if (recordButton) {
                    recordButton.textContent = 'ğŸ¤ ë…¹ìŒ';
                    recordButton.classList.remove('bg-gray-500', 'animate-pulse');
                    recordButton.classList.add('bg-red-500', 'hover:bg-red-600');
                }
                if (myPronunciationButton) {
                    myPronunciationButton.textContent = 'ğŸ—£ï¸ ì¬ìƒ';
                    myPronunciationButton.disabled = true;
                }
                
                if (playbackButtons) playbackButtons.classList.add('hidden'); 

                answerInput.disabled = false;
                
                checkButton.disabled = false;
                checkButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                checkButton.classList.add('bg-violet-600', 'hover:bg-violet-700', 'transform', 'hover:scale-105');
                nextButton.disabled = true;
                nextButton.classList.remove('bg-violet-600', 'hover:bg-violet-700', 'transform', 'hover:scale-105');
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                // ìƒˆë¡œìš´ ë¬¸ì œ ë¡œë“œ ì‹œ ì…ë ¥ í•„ë“œì— ë‹¤ì‹œ í¬ì»¤ìŠ¤ë¥¼ ë§ì¶¥ë‹ˆë‹¤. (í‚¤ë³´ë“œ ì‚¬ìš©ì„ ìœ„í•¨)
                answerInput.focus();
            } else {
                showResult();
            }
        }

        /**
         * í˜„ì¬ ëª¨ë“œì™€ ì§ˆë¬¸ì— ë§ëŠ” ìˆœìˆ˜í•œ ë…ì¼ì–´ ë‹¨ì–´/ë¬¸ì¥ ì •ë‹µ ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         * ìˆ«ì í˜•ì‹ì€ ë°˜í™˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
         */
        function getPossibleWordAnswers(question, mode) {
            let wordAnswers = [];
            const hasInformal = question.german.length > 1;

            // 1. ëª¨ë“œë³„ ì •ë‹µ ì„¤ì • (ë…ì¼ì–´ ë¬¸ì¥/ë‹¨ì–´ë§Œ)
            if (mode === 'formal') { 
                // ì‹œê°„ ë§í•˜ê¸° 1: í˜•ì‹ í‘œí˜„(german[0])ë§Œ ì •ë‹µìœ¼ë¡œ ì¸ì •
                wordAnswers.push(question.german[0]);
            } else if (mode === 'mixed') { 
                if (hasInformal) {
                    // ì‹œê°„ ë§í•˜ê¸° 2: ë¹„í˜•ì‹ í‘œí˜„(german[1])ë§Œ ì •ë‹µìœ¼ë¡œ ì¸ì •
                    wordAnswers.push(question.german[1]); 
                    // í˜¼í•© ëª¨ë“œì—ì„œëŠ” í˜•ì‹ í‘œí˜„ë„ ì¼ë‹¨ í—ˆìš© (ì •ë‹µ ì²˜ë¦¬ ê¸°ì¤€)
                    wordAnswers.push(question.german[0]);
                } else {
                    // ì•ˆì „ ì¥ì¹˜: ë¹„í˜•ì‹ í‘œí˜„ì´ ì—†ëŠ” ê²½ìš° í˜•ì‹ í‘œí˜„ ì¸ì •
                    wordAnswers.push(question.german[0]); 
                }
            }
            
            return [...new Set(wordAnswers)]; 
        }

        /**
         * ë””ì§€í„¸ ì‹œê°„ í˜•ì‹ì˜ ëª¨ë“  ì •ë‹µ í›„ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * STTê°€ ë‹¤ì–‘í•œ í˜•ì‹(0:45, 00:45, 12:45 ë“±)ìœ¼ë¡œ ì¸ì‹í•˜ëŠ” ê²ƒì„ ë³´ì •í•©ë‹ˆë‹¤.
         */
        function getDigitAnswers(timeString) {
            const answers = new Set();
            const timeWithoutUhr = timeString.replace(' Uhr', '');
            const [hour24, minute] = timeWithoutUhr.split(':').map(Number);
            const minutePadded = minute.toString().padStart(2, '0');

            // 12ì‹œ/0ì‹œ ê²½ê³„ì—ì„œ ë°œìƒí•˜ëŠ” STT ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´,
            // 12ì‹œ(12:XX)ëŠ” 0ì‹œ(00:XX)ë¥¼, 0ì‹œ(00:XX)ëŠ” 12ì‹œ(12:XX)ë¥¼ í—ˆìš©ë˜ëŠ” ì‹œê°„ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
            let equivalentHours = [hour24];
            if (hour24 === 12) {
                equivalentHours.push(0); 
            } else if (hour24 === 0) {
                equivalentHours.push(12); 
            }

            equivalentHours.forEach(h24 => {
                const hourPadded = h24.toString().padStart(2, '0'); // ì˜ˆ: 0 -> "00", 12 -> "12"
                const hourNoZero = h24.toString(); // ì˜ˆ: 0 -> "0", 12 -> "12"
                
                // 1. 24-hour formats (padded and non-padded minute)
                const times = [
                    `${hourPadded}:${minutePadded}`, // 00:45, 12:45
                    `${hourNoZero}:${minutePadded}`, // 0:45, 12:45
                    `${hourPadded}:${minute}`,      // 00:45, 12:45 (non-padded minute)
                    `${hourNoZero}:${minute}`,      // 0:45, 12:45 (non-padded minute)
                ];

                times.forEach(t => {
                    if (t.includes(':')) {
                        // Add basic forms
                        answers.add(t);
                        answers.add(`${t} Uhr`);
                        
                        // Add forms with different separators and spaces
                        const t_space = t.replace(':', ' '); // e.g., "0 45", "12 45"
                        const t_dot = t.replace(':', '.');   // e.g., "0.45", "12.45"
                        
                        answers.add(t_space);
                        answers.add(`${t_space} Uhr`);
                        answers.add(t_dot);
                        answers.add(`${t_dot} Uhr`);
                    }
                });

                // 2. 12-hour formats (Only for display purposes, usually 1-12)
                if (h24 !== 0) { // 00:XX ì‹œê°„ì—ëŠ” 12ì‹œê°„ í˜•ì‹(12:XX)ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì œì™¸
                    const hour12 = h24 % 12 || 12; // 12ì‹œê°„ í˜•ì‹ ë³€í™˜
                    const time12h = `${hour12}:${minutePadded}`;
                    
                    answers.add(time12h);
                    answers.add(`${time12h} Uhr`);
                    
                    // 12-hour with non-padded minute
                    answers.add(`${hour12}:${minute}`);
                    
                    // H:MM space/dot variants
                    answers.add(time12h.replace(':', ' '));
                    answers.add(time12h.replace(':', '.'));
                    
                    // H (ì •ê°ì¼ ê²½ìš°)
                    if (minute === 0) {
                        answers.add(`${hour12}`); 
                        answers.add(`${hour12} Uhr`); 
                    }
                }
            });
            
            return Array.from(answers);
        }


        function checkAnswer(isVoiceInput = false) {
            stopListening(); 
            
            const currentQuestion = currentQuizSet[currentQuestionIndex];
            
            // ëª©í‘œ ë…ì¼ì–´ í‘œí˜„ í™•ì¸ (í”¼ë“œë°± ë©”ì‹œì§€ìš©)
            // expectedPhraseëŠ” í˜„ì¬ ëª¨ë“œì˜ 'ëª©í‘œ' ì •ë‹µì´ ë©ë‹ˆë‹¤.
            const expectedPhrase = currentMode === 'mixed' && currentQuestion.german.length > 1 
                                 ? currentQuestion.german[1] // ë¹„í˜•ì‹ í‘œí˜„ì´ ëª©í‘œ
                                 : currentQuestion.german[0]; // í˜•ì‹ í‘œí˜„ ë˜ëŠ” ìœ ì¼í•œ í‘œí˜„


            // 1. ë…ì¼ì–´ ë‹¨ì–´ ì •ë‹µ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const wordAnswers = getPossibleWordAnswers(currentQuestion, currentMode);
            
            // 2. ìˆ«ì í˜•ì‹ ì •ë‹µì„ ê°€ì ¸ì˜µë‹ˆë‹¤. (STT ë³´ì •ìš©)
            const digitAnswers = getDigitAnswers(currentQuestion.korean);

            let userInput = answerInput.value.trim();
            const cleanUserInput = normalizeVoiceInput(userInput);
            
            // --- 1. ì…ë ¥ì´ ìš”êµ¬ë˜ëŠ” ë…ì¼ì–´ í‘œí˜„ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (Word-to-Word) ---
            const isWordCorrect = wordAnswers.some(ans => normalizeVoiceInput(ans) === cleanUserInput);

            // --- 2. ì…ë ¥ì´ ë””ì§€í„¸ ì‹œê°„ í˜•ì‹ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (Digit-to-Digit) ---
            const isDigitCorrect = digitAnswers.some(d => normalizeVoiceInput(d) === cleanUserInput);

            // --- 3. ì…ë ¥ì´ ìˆ«ì+ë…ì¼ì–´ í˜¼í•© í˜•ì‹ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (Mixed-Digit-Word) ---
            const isMixedCorrect = wordAnswers.some(ans => {
                const mixedAns = normalizeToMixedDigit(ans); // ì˜ˆ: "zwanzig nach fÃ¼nf" -> "20 nach 5"
                return mixedAns === cleanUserInput;
            });

            // 4. ìµœì¢… ì •ë‹µ ì—¬ë¶€ ê²°ì • (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜: í‚¤ë³´ë“œ ì…ë ¥ ì‹œ ë””ì§€í„¸ í˜•ì‹/í˜¼í•© í˜•ì‹ ë¶ˆí—ˆ)
            let isCorrect = false;

            if (isWordCorrect) {
                isCorrect = true;
            } else if (isVoiceInput && isDigitCorrect) {
                isCorrect = true;
            } else if (isVoiceInput && isMixedCorrect) {
                isCorrect = true;
            }


            // í”¼ë“œë°± ë©”ì‹œì§€ ìƒì„±
            if (isCorrect) {
                let feedbackMsg = `âœ… ì •ë‹µì…ë‹ˆë‹¤! ğŸ˜Š (ì •ë‹µ: ${expectedPhrase})`; // ê¸°ë³¸ ì •ë‹µ í‘œì‹œ

                // STT ë³´ì • ê´€ë ¨ ë¬¸êµ¬ëŠ” ì œê±°í•˜ê³ , ëª©í‘œ í‘œí˜„ë§Œ ì•ˆë‚´í•˜ëŠ” ë¬¸êµ¬ë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
                if (currentMode === 'mixed' && currentQuestion.german.length > 1 && cleanUserInput === normalizeVoiceInput(currentQuestion.german[0])) {
                    // ì‹œê°„ ë§í•˜ê¸° 2 ëª¨ë“œì¸ë° í˜•ì‹ í‘œí˜„ì„ ì¼ì„ ê²½ìš° (ì •ë‹µì€ ë§ì§€ë§Œ ëª©í‘œê°€ ì•„ë‹ˆì—ˆìŒ)
                     feedbackMsg = `âœ… ì •ë‹µì…ë‹ˆë‹¤! ğŸ˜Š (ì •ë‹µì´ì§€ë§Œ, ì´ ëª¨ë“œì˜ ëª©í‘œ ë¹„í˜•ì‹ í‘œí˜„ì€: "${expectedPhrase}" ì…ë‹ˆë‹¤.)`;
                }

                feedbackElement.textContent = feedbackMsg;
                feedbackElement.classList.remove('text-red-600');
                feedbackElement.classList.add('text-green-600');
                score++;
            } else {
                // ëª¨ë“œì— ë”°ë¼ ì •ë‹µ ì•ˆë‚´ ë©”ì‹œì§€ ë³€ê²½
                let correctMsg = '';

                if (currentMode === 'formal') {
                    correctMsg = `âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. (ì •ë‹µ): ${expectedPhrase}`;
                } else if (currentMode === 'mixed') {
                    correctMsg = `âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. (ë¹„í˜•ì‹ ëª©í‘œ ì •ë‹µ): ${expectedPhrase}`;
                }
                
                // í‚¤ë³´ë“œ ì…ë ¥ìœ¼ë¡œ ë””ì§€í„¸/í˜¼í•© í˜•ì‹ì„ ì…ë ¥í–ˆì„ ê²½ìš° íŠ¹ë³„ í”¼ë“œë°±
                if (!isVoiceInput && (isDigitCorrect || isMixedCorrect)) {
                    correctMsg += ` (í‚¤ë³´ë“œ ì…ë ¥ ì‹œì—ëŠ” ë°˜ë“œì‹œ ë…ì¼ì–´ í‘œí˜„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.)`;
                }
                
                feedbackElement.textContent = correctMsg;
                feedbackElement.classList.remove('text-green-600');
                feedbackElement.classList.add('text-red-600');
            }
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë‹¤ìŒ ë‹¨ê³„ ì¤€ë¹„
            recordedChunks = [];
            if (myPronunciationButton) {
                myPronunciationButton.disabled = true;
                myPronunciationButton.textContent = 'ğŸ—£ï¸ ì¬ìƒ';
            }

            speakGerman();
            
            // ** ìš”ì²­ì— ë”°ë¼ ì•ˆë‚´ ë¬¸êµ¬ ìœ„ì¹˜ ë³€ê²½ **
            pronunciationGuide.textContent = 'ë°œìŒ ì—°ìŠµì„ ì›í•˜ì‹œë©´ "ë“£ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ "ë…¹ìŒ" ë²„íŠ¼ìœ¼ë¡œ ì—°ìŠµí•´ë³´ì„¸ìš”.'; 
            wordInfoElement.textContent = ''; // ì´ì „ ìœ„ì¹˜ëŠ” ë¹„ì›Œë‘¡ë‹ˆë‹¤.
            
            if (playbackButtons) {
                playbackButtons.classList.remove('hidden');
            }
            
            answerInput.disabled = true;
            checkButton.disabled = true;
            checkButton.classList.remove('bg-violet-600', 'hover:bg-violet-700', 'transform', 'hover:scale-105');
            checkButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            nextButton.disabled = false;
            nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            nextButton.classList.add('bg-violet-600', 'hover:bg-violet-700', 'transform', 'hover:scale-105');
            
            // ì •ë‹µ í™•ì¸ í›„, ë‹¤ìŒ ì—”í„° í‚¤ ì…ë ¥ì„ ìœ„í•´ í¬ì»¤ìŠ¤ë¥¼ 'ë‹¤ìŒ ë¬¸ì œ' ë²„íŠ¼ìœ¼ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.
            nextButton.focus(); 
        }

        function updateProgress() {
            progressText.textContent = `ë¬¸ì œ ${currentQuestionIndex + 1} / ${currentQuizSet.length}`;
            if (currentQuestionIndex >= currentQuizSet.length) {
                progressText.textContent = `í€´ì¦ˆ ì™„ë£Œ!`;
            }
        }
        
        function showResult() {
            quizArea.classList.add('hidden');
            resultArea.classList.remove('hidden');
            scoreText.textContent = `ì ìˆ˜: ${score} / ${currentQuizSet.length}`;
            stopListening(); 
        }
        
        function speakGerman() {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            if ('speechSynthesis' in window) {
                const currentQuestion = currentQuizSet[currentQuestionIndex];
                let textToSpeak = '';
                
                // ëª¨ë“œì— ë”°ë¼ TTS í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
                if (currentMode === 'mixed' && currentQuestion.german.length > 1) {
                    // ì‹œê°„ ë§í•˜ê¸° 2 ëª¨ë“œì—ì„œëŠ” ë¹„í˜•ì‹ í‘œí˜„(german[1])ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    textToSpeak = currentQuestion.german[1];
                } else {
                    // ì‹œê°„ ë§í•˜ê¸° 1 ëª¨ë“œ ë˜ëŠ” ë¹„í˜•ì‹ í‘œí˜„ì´ ì—†ëŠ” ë¬¸ì œëŠ” í˜•ì‹ í‘œí˜„(german[0])ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    textToSpeak = currentQuestion.german[0]; 
                }
                
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'de-DE'; 
                window.speechSynthesis.speak(utterance);
            } else {
                console.error('Text-to-speech not supported in this browser.');
                showMessage('âš ï¸ ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', true);
            }
        }

        // --- ì˜¤ë””ì˜¤ ë…¹ìŒ/ì¬ìƒ ë¡œì§ ---

        function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showMessage('âš ï¸ ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë…¹ìŒ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', true);
                return;
            }

            if (isRecording) {
                stopRecording();
                return;
            }

            // ë…¹ìŒ ì‹œì‘ ì‹œ ë‹¤ì‹œ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (event) => {
                        recordedChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/webm; codecs=opus' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // ì¬ìƒ ë²„íŠ¼ í™œì„±í™” ë° URL ì €ì¥
                        myPronunciationButton.onclick = () => {
                            const audio = new Audio(audioUrl);
                            audio.play();
                        };
                        myPronunciationButton.disabled = false;
                        myPronunciationButton.textContent = 'ğŸ—£ï¸ ì¬ìƒ';
                        
                        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                        stream.getTracks().forEach(track => track.stop());
                    };

                    recordedChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    recordButton.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘ (ì¤‘ì§€)';
                    recordButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                    recordButton.classList.add('bg-gray-500', 'animate-pulse');
                    showMessage('ğŸ™ï¸ ë…ì¼ì–´ ë°œìŒì„ ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤...', false);
                })
                .catch(error => {
                    console.error('Recording Error:', error);
                    if (error.name === 'NotAllowedError') {
                        showMessage('âš ï¸ ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', true);
                    } else {
                        showMessage('âš ï¸ ë…¹ìŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
                    }
                });
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                recordButton.textContent = 'ğŸ¤ ë…¹ìŒ';
                recordButton.classList.remove('bg-gray-500', 'animate-pulse');
                recordButton.classList.add('bg-red-500', 'hover:bg-red-600');
                showMessage('ğŸ’¾ ë…¹ìŒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”.', false);
            }
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

        // ëª¨ë“œ ì„ íƒ ì´ë²¤íŠ¸
        modeFormalButton.addEventListener('click', () => startQuiz('formal'));
        modeMixedButton.addEventListener('click', () => startQuiz('mixed'));

        // í€´ì¦ˆ ì§„í–‰ ì´ë²¤íŠ¸
        checkButton.addEventListener('click', () => checkAnswer(false)); // í‚¤ë³´ë“œ ì…ë ¥: false
        nextButton.addEventListener('click', () => {
            currentQuestionIndex++;
            updateProgress();
            loadQuestion();
        });

        // =================================================================
        // *** ì—”í„° í‚¤ë¡œ ì •ë‹µ í™•ì¸ ë° ë‹¤ìŒ ë¬¸ì œ ì´ë™ ì²˜ë¦¬ ***
        // =================================================================
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                
                if (!checkButton.disabled) {
                    // 1. 'í™•ì¸' ë²„íŠ¼ì´ í™œì„±í™”ëœ ìƒíƒœ (ì •ë‹µ ì…ë ¥ ì „) -> ì •ë‹µ í™•ì¸
                    checkButton.click();
                } else if (!nextButton.disabled) {
                    // 2. 'ë‹¤ìŒ ë¬¸ì œ' ë²„íŠ¼ì´ í™œì„±í™”ëœ ìƒíƒœ (ì •ë‹µ í™•ì¸ í›„) -> ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                    nextButton.click();
                }
            }
        });

        // ê²°ê³¼ í™”ë©´ ì´ë²¤íŠ¸
        restartButton.addEventListener('click', () => startQuiz(currentMode));
        goToSelectionButton.addEventListener('click', showSelectionScreen);
        
        // ìŒì„±/ë°œìŒ ì—°ìŠµ ì´ë²¤íŠ¸
        nativeListenButton.addEventListener('click', speakGerman);
        recordButton.addEventListener('click', startRecording);
        voiceInputButton.addEventListener('click', toggleVoiceInput);
        
        // ì´ˆê¸° ë¡œë“œ
        window.onload = () => {
             // TTS/STT ì§€ì› ì—¬ë¶€ í™•ì¸
            if (!isSttSupported) {
                voiceInputButton.disabled = true;
                voiceInputButton.title = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                voiceInputButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            if (!('speechSynthesis' in window)) {
                 nativeListenButton.disabled = true;
                 nativeListenButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            showSelectionScreen();
        };

    </script>
</body>
</html>
