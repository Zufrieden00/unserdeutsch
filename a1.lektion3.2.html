<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lektion 3.2 통과시험</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for microphone icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font (Inter) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .answer-container {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
            max-height: 0;
        }
        .answer-container.visible {
            max-height: 100px;
        }
        .microphone-btn {
            background-color: #ef4444;
            color: #fff;
            padding: 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .microphone-btn:hover {
            background-color: #dc2626;
            transform: scale(1.05);
        }
        .microphone-btn.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="message-box" class="message-box"></div>

    <div class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-xl max-w-2xl w-full">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-yellow-300">Lektion 3.2 통과시험</h1>
        <div id="start-screen" class="text-center">
            <h2 class="text-2xl md:text-3xl font-bold mb-4">퀴즈 유형을 선택하세요.</h2>
            <p class="text-gray-400 mb-8">
                선택하신 유형으로만 모든 문제가 출제됩니다.
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="start-writing-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                    📝 작문 퀴즈 시작
                </button>
                <button id="start-speaking-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                    🎙️ 말하기 퀴즈 시작
                </button>
            </div>
        </div>

        <p id="quiz-instructions" class="text-center text-gray-400 mb-8 hidden">
            <!-- Instructions will be updated dynamically -->
        </p>
        
        <div id="quiz-status" class="text-center text-xl font-semibold mb-6 hidden"></div>

        <div id="single-quiz-item" class="bg-gray-700 p-6 rounded-xl shadow-md space-y-4 hidden">
            <!-- The current quiz question will be rendered here -->
        </div>

        <div id="quiz-controls" class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 hidden">
            <!-- Buttons will be rendered dynamically -->
        </div>

        <div id="final-results" class="mt-8 text-center hidden">
            <h2 class="text-2xl font-bold mb-4 text-green-400">퀴즈 결과</h2>
            <p id="final-score" class="text-xl mb-2"></p>
            <p id="pass-fail-message" class="text-3xl font-bold"></p>
            <button id="restart-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                처음으로 돌아가기
            </button>
        </div>
    </div>

    <script>
        // Check for Web Speech API browser support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecognizing = false; // Add a flag to track the recognition state
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            // Speaking quiz now expects German input, so change the language
            recognition.lang = 'de-DE';
            recognition.continuous = false; // Stop listening after one result
            recognition.interimResults = false; // Only return final results
        }

        // Show a temporary message box
        function showMessageBox(message) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.classList.add('show');
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        }

        /**
         * 음성 인식 결과와 정답을 비교하기 위해 텍스트를 정규화하는 함수
         * - 모든 문자를 소문자로 변환합니다.
         * - 문장 부호와 공백을 제거합니다.
         * @param {string} text - 정규화할 텍스트
         * @returns {string} 정규화된 텍스트
         */
        function normalizeSpeechText(text) {
            // 모든 문자를 소문자로 변환하고, 문자(글자)와 숫자(숫자)를 제외한 모든 문자를 제거
            // \p{L}은 모든 유니코드 문자를 의미, \p{N}은 모든 유니코드 숫자를 의미
            // 'gu' 플래그는 전역(g) 및 유니코드(u) 일치에 필요
            return text.toLowerCase().replace(/[^\p{L}\p{N}]/gu, '');
        }

        // 퀴즈 문제-정답 데이터.
        // 정답이 여러 개일 수 있는 경우 배열로 정의합니다.
        const quizData = [
            { question: "철자를 말해주세요.", answers: ["Buchstabieren Sie, bitte.", "Buchstabieren Sie.", "Bitte buchstabieren Sie."] },
            { question: "철자를 말해줘.", answers: ["Buchstabier, bitte.", "Buchstabiere, bitte.", "Buchstabier.", "Buchstabiere.", "Bitte buchstabier.", "Bitte buchstabiere."] },
            { question: "다시 말해주세요.", answers: ["Wiederholen Sie, bitte.", "Wiederholen Sie.", "Bitte wiederholen Sie."] },
            { question: "다시 말해줘.", answers: ["Wiederhol, bitte.", "Wiederhole, bitte.", "Wiederhol.", "Wiederhole.", "Bitte wiederhol.", "Bitte wiederhole."] },
            { question: "톰슨 씨에게 물어보세요.", answers: ["Fragen Sie bitte Herrn Thomson.", "Fragen Sie Herrn Thomson.", "Bitte fragen Sie Herrn Thomson.", "Fragen Sie bitte Herrn Thompson.", "Fragen Sie Herrn Thompson.", "Bitte fragen Sie Herrn Thompson."] },
            { question: "톰슨 씨에게 물어봐.", answers: ["Frag bitte Herrn Thomson.", "Frage bitte Herrn Thomson.", "Frag Herrn Thomson.", "Frage Herrn Thomson.", "Bitte frag Herrn Thomson.", "Bitte frage Herrn Thomson.", "Frag bitte Herrn Thompson.", "Frage bitte Herrn Thompson.", "Frag Herrn Thompson.", "Frage Herrn Thompson.", "Bitte frag Herrn Thompson.", "Bitte frage Herrn Thompson."] },
            { question: "좋아요./좋아.", answers: ["gerne.", "Gerne."] },
            { question: "그렇게 할게요.", answers: ["Das mache ich."] },
            { question: "그건 모르겠어요.", answers: ["Das weiß ich nicht."] },
            { question: "기다려주세요.", answers: ["Warten Sie, bitte.", "Warten Sie.", "Bitte warten Sie."] },
            { question: "기다려봐.", answers: ["Warte."] },
            { question: "그 단어를 읽어주세요.", answers: ["Lesen Sie bitte das Wort.", "Lesen Sie das Wort.", "Bitte lesen Sie das Wort."] },
            { question: "그 단어를 읽어줘.", answers: ["Lies bitte das Wort.", "Lies das Wort.", "Bitte lies das Wort."] },
            { question: "이메일을 써주세요.", answers: ["Schreiben Sie bitte eine E-mail.", "Schreiben Sie bitte eine Email.", "Schreiben Sie eine E-mail.", "Schreiben Sie eine Email.", "Bitte schreiben Sie eine E-mail.", "Bitte schreiben Sie eine Email."] },
            { question: "이메일을 써줘.", answers: ["Schreib bitte eine E-mail.", "Schreibe bitte eine E-mail.", "Schreib bitte eine Email.", "Schreibe bitte eine Email.", "Schreib eine E-mail.", "Schreibe eine E-mail.", "Schreib eine Email.", "Schreibe eine Email.", "Bitte schreib eine E-mail.", "Bitte schreibe eine E-mail.", "Bitte schreib eine Email.", "Bitte schreibe eine Email."] },
            { question: "질문을 다시 말해주세요.", answers: ["Wiederholen Sie bitte die Frage.", "Wiederholen Sie die Frage.", "Bitte wiederholen Sie die Frage."] },
            { question: "질문을 다시 말해줘.", answers: ["Wiederhol bitte die Frage.", "Wiederhole bitte die Frage.", "Wiederhol die Frage.", "Wiederhole die Frage.", "Bitte wiederhol die Frage.", "Bitte wiederhole die Frage."] },
            { question: "본문을 읽으세요.", answers: ["Lesen Sie den Text."] },
            { question: "본문을 읽어.", answers: ["Lies den Text."] },
            { question: "문장들을 쓰세요.", answers: ["Schreiben Sie die Sätze."] },
            { question: "문장들을 써.", answers: ["Schreib die Sätze.", "Schreibe die Sätze."] },
            { question: "대화를 들으세요.", answers: ["Hören Sie den Dialog."] },
            { question: "대화를 들어.", answers: ["Hör den Dialog.", "Höre den Dialog."] },
            { question: "본문을 형광펜으로 표시하세요.", answers: ["Markieren Sie den Text."] },
            { question: "본문을 형광펜으로 표시해.", answers: ["Markier den Text.", "Markiere den Text."] },
            { question: "명사는 대문자로 쓰세요.", answers: ["Schreiben Sie Nomen groß."] },
            { question: "명사는 대문자로 써.", answers: ["Schreib Nomen groß.", "Schreibe Nomen groß."] }
        ];

        let shuffledQuizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let currentQuizType = null;
        
        // DOM 요소 가져오기
        const startScreen = document.getElementById('start-screen');
        const quizStatus = document.getElementById('quiz-status');
        const singleQuizItem = document.getElementById('single-quiz-item');
        const quizControls = document.getElementById('quiz-controls');
        const finalResults = document.getElementById('final-results');
        const finalScoreElem = document.getElementById('final-score');
        const passFailMessageElem = document.getElementById('pass-fail-message');
        const quizInstructions = document.getElementById('quiz-instructions');
        const restartBtn = document.getElementById('restart-btn');

        // Fisher-Yates 셔플 알고리즘으로 배열을 섞는 함수
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 퀴즈 시작 함수 (유형 선택)
        function startQuiz(type) {
            currentQuizType = type;
            shuffledQuizData = shuffleArray([...quizData]);
            currentQuestionIndex = 0;
            score = 0;
            totalQuestions = quizData.length;

            // UI 상태 변경
            startScreen.classList.add('hidden');
            quizStatus.classList.remove('hidden');
            quizInstructions.classList.remove('hidden');
            singleQuizItem.classList.remove('hidden');
            quizControls.classList.remove('hidden');
            finalResults.classList.add('hidden');

            renderQuestion();
        }

        // 현재 문제를 렌더링하는 함수
        function renderQuestion() {
            // 현재 문제 상태 업데이트
            quizStatus.textContent = `문제 ${currentQuestionIndex + 1} / ${totalQuestions} (맞은 개수: ${score}개)`;

            const currentQuestion = shuffledQuizData[currentQuestionIndex];
            
            if (currentQuizType === 'writing') {
                quizInstructions.textContent = "아래 한국어 문장을 독일어로 바르게 작문해 보세요.";
                singleQuizItem.innerHTML = `
                    <p class="text-xl font-medium mb-4">문제. ${currentQuestion.question}</p>
                    <input type="text" id="user-input" placeholder="여기에 정답을 입력하세요..." class="w-full bg-gray-600 text-white placeholder-gray-400 border border-gray-500 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="answer-feedback" class="mt-4 hidden text-lg font-bold"></div>
                    <div id="correct-answer-container" class="answer-container mt-2">
                        <div class="bg-gray-600 p-3 rounded-lg text-gray-300">
                            정답: <span id="correct-answer-text" class="font-bold"></span>
                        </div>
                    </div>
                `;
                quizControls.innerHTML = `
                    <button id="submit-btn" class="bg-yellow-400 text-gray-900 font-semibold py-3 px-6 rounded-xl hover:bg-yellow-500 transition-colors duration-300 shadow-lg">
                        정답 제출
                    </button>
                    <button id="next-question-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg hidden">
                        다음 문제
                    </button>
                `;
                document.getElementById('submit-btn').addEventListener('click', () => checkAnswer(document.getElementById('user-input').value));
            } else { // 'speaking'
                quizInstructions.textContent = "아래 한국어 문장을 듣고 독일어로 말해보세요.";
                singleQuizItem.innerHTML = `
                    <p class="text-xl font-medium mb-4">문제. ${currentQuestion.question}</p>
                    <div class="flex items-center justify-center space-x-4">
                        <button id="record-btn" class="microphone-btn"><i class="fas fa-microphone text-2xl"></i></button>
                        <p id="speech-text" class="text-lg text-gray-300">마이크 버튼을 누르고 답을 말하세요.</p>
                    </div>
                    <div id="answer-feedback" class="mt-4 hidden text-lg font-bold"></div>
                    <div id="correct-answer-container" class="answer-container mt-2">
                        <div class="bg-gray-600 p-3 rounded-lg text-gray-300">
                            정답: <span id="correct-answer-text" class="font-bold"></span>
                        </div>
                    </div>
                `;
                quizControls.innerHTML = `
                    <button id="next-question-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 shadow-lg hidden">
                        다음 문제
                    </button>
                `;
                document.getElementById('record-btn').addEventListener('click', startRecording);
            }

            document.getElementById('next-question-btn').addEventListener('click', nextQuestion);
            
            // 다음 문제로 넘어갈 때 자동으로 입력창에 포커스를 맞춥니다.
            setTimeout(() => {
                const userInput = document.getElementById('user-input');
                if (userInput) {
                    userInput.focus();
                }
            }, 0);
        }

        // 음성 인식 시작
        function startRecording() {
            if (!recognition) {
                showMessageBox('음성 인식을 지원하지 않는 브라우저입니다.');
                return;
            }

            // If recognition is already in progress, do nothing
            if (isRecognizing) {
                console.log("Recognition is already in progress.");
                return;
            }
            
            isRecognizing = true;
            const recordBtn = document.getElementById('record-btn');
            const speechText = document.getElementById('speech-text');

            recordBtn.classList.add('listening');
            speechText.textContent = '말씀해 주세요...';
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                speechText.textContent = transcript;
                checkAnswer(transcript);
            };

            recognition.onerror = (event) => {
                console.error(event.error);
                recordBtn.classList.remove('listening');
                speechText.textContent = '음성 인식 오류. 다시 시도해 주세요.';
                isRecognizing = false; // Reset the flag on error
            };
            
            recognition.onend = () => {
                recordBtn.classList.remove('listening');
                isRecognizing = false; // Reset the flag when recognition ends
            };

            try {
                recognition.start();
            } catch(e) {
                console.error(e);
                showMessageBox('음성 인식 시작에 실패했습니다. 마이크 권한을 확인해 주세요.');
                recordBtn.classList.remove('listening');
                speechText.textContent = '마이크 버튼을 누르고 답을 말하세요.';
                isRecognizing = false; // Reset the flag on catch
            }
        }

        // 정답을 체크하는 함수
        function checkAnswer(userInputText) {
            const currentQuestion = shuffledQuizData[currentQuestionIndex];
            const answerFeedback = document.getElementById('answer-feedback');
            const correctAnswerContainer = document.getElementById('correct-answer-container');
            const correctAnswerText = document.getElementById('correct-answer-text');
            const submitBtn = document.getElementById('submit-btn');
            const nextBtn = document.getElementById('next-question-btn');
            
            let isCorrect = false;
            
            // 정답 표시
            correctAnswerText.textContent = currentQuestion.answers.join(' 또는 ');
            correctAnswerContainer.classList.add('visible');

            // 채점 및 피드백 로직
            if (currentQuizType === 'writing') {
                // 작문 퀴즈는 대소문자 및 문장 부호를 무시하고 검사
                const normalizedUserInput = normalizeSpeechText(userInputText);
                const normalizedAnswers = currentQuestion.answers.map(answer => normalizeSpeechText(answer));
                isCorrect = normalizedAnswers.includes(normalizedUserInput);
                
                if (isCorrect) {
                    answerFeedback.textContent = '🎉 정답입니다!';
                    answerFeedback.className = 'mt-4 text-lg font-bold text-green-400';
                    score++;
                } else {
                    answerFeedback.textContent = '아쉽지만 오답입니다. 😭';
                    answerFeedback.className = 'mt-4 text-lg font-bold text-red-400';
                }
                document.getElementById('user-input').disabled = true;
                if (submitBtn) submitBtn.classList.add('hidden');
            } else { // 'speaking'
                // 말하기 퀴즈는 대소문자 및 특수 기호를 무시하고 검사
                const normalizedUserInput = normalizeSpeechText(userInputText);
                // 음성 인식된 텍스트에 정답이 포함되어 있는지 확인합니다.
                isCorrect = currentQuestion.answers.some(answer => normalizedUserInput.includes(normalizeSpeechText(answer)));

                if (isCorrect) {
                    answerFeedback.textContent = '🎉 정답입니다!';
                    answerFeedback.className = 'mt-4 text-lg font-bold text-green-400';
                    score++;
                } else {
                    answerFeedback.textContent = '아쉽지만 오답입니다. 😭';
                    answerFeedback.className = 'mt-4 text-lg font-bold text-red-400';
                }
                document.getElementById('record-btn').disabled = true;
            }

            answerFeedback.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            quizStatus.textContent = `문제 ${currentQuestionIndex + 1} / ${totalQuestions} (맞은 개수: ${score}개)`;
        }

        // 다음 문제로 넘어가는 함수
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < totalQuestions) {
                renderQuestion();
            } else {
                // 퀴즈 종료
                endQuiz();
            }
        }

        // 퀴즈 종료 시 결과 표시
        function endQuiz() {
            singleQuizItem.classList.add('hidden');
            quizInstructions.classList.add('hidden');
            quizStatus.classList.add('hidden');
            quizControls.classList.add('hidden');
            
            finalResults.classList.remove('hidden');
            
            const totalScore = Math.round((score / totalQuestions) * 100);
            finalScoreElem.textContent = `최종 점수: ${totalScore}점`;
            
            // 합격/불합격 판정
            if (totalScore >= 80) {
                passFailMessageElem.textContent = '합격입니다! 축하해요!';
                passFailMessageElem.className = 'text-3xl font-bold text-green-400';
            } else {
                passFailMessageElem.innerHTML = '아쉽지만 불합격입니다.<br>다시 도전해 보세요!';
                passFailMessageElem.className = 'text-3xl font-bold text-red-400';
            }
            
            document.getElementById('restart-btn').addEventListener('click', resetQuiz);
        }

        // 퀴즈를 처음 상태로 되돌리는 함수
        function resetQuiz() {
            startScreen.classList.remove('hidden');
            quizStatus.classList.add('hidden');
            quizInstructions.classList.add('hidden');
            singleQuizItem.classList.add('hidden');
            quizControls.classList.add('hidden');
            finalResults.classList.add('hidden');
        }
        
        // 페이지 로드 시 시작 화면을 표시하고 이벤트 리스너를 설정
        window.onload = function() {
            document.getElementById('start-writing-btn').addEventListener('click', () => startQuiz('writing'));
            document.getElementById('start-speaking-btn').addEventListener('click', () => startQuiz('speaking'));
            restartBtn.addEventListener('click', resetQuiz);
        };

        // 문서 전체에 키보드 이벤트 리스너 추가
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const submitBtn = document.getElementById('submit-btn');
                const nextBtn = document.getElementById('next-question-btn');
                
                // '정답 제출' 버튼이 보일 때 엔터를 누르면 정답 체크
                if (submitBtn && !submitBtn.classList.contains('hidden')) {
                    checkAnswer(document.getElementById('user-input').value);
                } 
                // '다음 문제' 버튼이 보일 때 엔터를 누르면 다음 문제로 이동
                else if (nextBtn && !nextBtn.classList.contains('hidden')) {
                    nextQuestion();
                }
            }
        });
    </script>
</body>
</html>
